<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>BotRabot Job Search</title>

  <!-- TG SDK + Tailwind -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      /* –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –≤—å—é–ø–æ—Ä—Ç–∞ TG; –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏–∑ JS */
      --tg-vh: 100dvh;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: #f8fafc;
      overflow-x: hidden;
    }

    /* –∫–æ—Ä–Ω–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É webview */
    #root {
      min-height: var(--tg-vh);
      padding-bottom: var(--safe-bottom);
      box-sizing: border-box;
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="module">
  import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
  import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

  const { createElement: h } = React;

  /* ---------------- Icons ---------------- */
  const ChevronRight = () => h('svg',{xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},h('polyline',{points:"9 18 15 12 9 6"}));

  /* ---------------- API ---------------- */
  const API_BASE_URL = 'https://mute-fae-macaroniu-ef8afb3f.koyeb.app';

  class ApiClient {
    constructor(baseUrl, initData) {
      this.baseUrl = baseUrl;
      this.initData = initData || ''; // –≤–Ω–µ TG ‚Äî –ø—É—Å—Ç–æ
    }
    async request(endpoint, options = {}) {
      const url = `${this.baseUrl}${endpoint}`;
      const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
      if (this.initData) headers['Authorization'] = this.initData;

      const resp = await fetch(url, { ...options, headers, mode: 'cors', credentials: 'omit' });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
      return resp.json();
    }
    getUserProfile() { return this.request('/user/profile'); }
    getUserResumes() { return this.request('/user/resumes'); }
    getPlans() { return this.request('/plans'); }
    updatePlan(planName) { return this.request('/user/update-plan', { method:'POST', body: JSON.stringify({ plan_name: planName }) }); }
  }

  /* --------- TG viewport helpers (full-screen) ---------- */
  function applyViewportHeight(vh) {
    // vh —É–∂–µ –≤ CSS-–ø–∏–∫—Å–µ–ª—è—Ö
    document.documentElement.style.setProperty('--tg-vh', vh ? `${vh}px` : `${window.innerHeight}px`);
  }

  function initTelegramViewport() {
    const tg = window.Telegram?.WebApp;
    if (!tg) {
      // –Ω–µ –≤ TG ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º dvh
      applyViewportHeight(window.innerHeight);
      window.addEventListener('resize', () => applyViewportHeight(window.innerHeight));
      return { tg: null, initData: '' };
    }

    try {
      tg.ready?.();
      tg.expand?.();               // —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –º–∞–∫—Å–∏–º—É–º
      tg.setBackgroundColor?.('#F8FAFC');
      tg.setHeaderColor?.('#1e293b');
    } catch(_) {}

    applyViewportHeight(tg.viewportHeight || window.innerHeight);
    tg.onEvent?.('viewportChanged', () => {
      applyViewportHeight(tg.viewportHeight || window.innerHeight);
    });

    return { tg, initData: tg.initData || '' };
  }

  /* ---------------- App ---------------- */
  function JobSearchApp() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
      const { initData } = initTelegramViewport();
      const client = new ApiClient(API_BASE_URL, initData);

      (async () => {
        try {
          // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥—Ç—è–Ω—É—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –ø–æ–ª—É—á–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ TG
          const [u, resumes] = await Promise.all([
            client.getUserProfile(),
            client.getUserResumes(),
          ]);
          setUser({
            name: u?.name,
            plan: u?.plan,
            resumeCount: Array.isArray(resumes) ? resumes.length : u?.resumeCount
          });
        } catch {
          // –í–Ω–µ TG –∏–ª–∏ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º, –ø—Ä–æ—Å—Ç–æ –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
          setUser(null);
          setError(null);
        } finally { setLoading(false); }
      })();
    }, []);

    if (loading) {
      return h('div', { className: 'min-h-screen flex items-center justify-center' },
        h('div', { className: 'text-center' },
          h('div', { className: 'w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-4' }),
          h('p', { className: 'text-slate-600' }, '–ó–∞–≥—Ä—É–∑–∫–∞...')
        )
      );
    }

    return h('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100' },
      h('div', { className: 'max-w-2xl mx-auto p-4 pb-8' },
        h('div', { className: 'bg-white rounded-2xl p-6 shadow-lg' },
          h('h2', { className: 'text-2xl font-bold mb-4' }, `–ü—Ä–∏–≤–µ—Ç${user?.name ? `, ${user.name}` : ''}! üëã`),
          user?.plan
            ? h('p', { className: 'text-slate-600' }, `–ü–ª–∞–Ω: ${user.plan}`)
            : h('p', { className: 'text-slate-600' }, '–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏ —Ä–µ–∑—é–º–µ'),
          user?.resumeCount != null && h('p', { className: 'text-slate-600' }, `–†–µ–∑—é–º–µ: ${user.resumeCount}`),

          h('div', { className: 'mt-6 flex items-center gap-2 text-indigo-600' },
            h('span', null, '–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∏—Å–∫—É –≤–∞–∫–∞–Ω—Å–∏–π'),
            h(ChevronRight)
          )
        )
      )
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(h(JobSearchApp));
</script>
</body>
</html>
