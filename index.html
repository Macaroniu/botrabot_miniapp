<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BotRabot Job Search</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        #root {
            min-height: 100vh;
        }
    </style>
</head>
<body>
<div id="root"></div>

<script type="module">
    import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

    const { createElement: h } = React;

    const Search = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('circle', { cx: 11, cy: 11, r: 8 }),
        h('path', { d: "m21 21-4.35-4.35" })
    );

    const User = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('path', { d: "M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" }),
        h('circle', { cx: 12, cy: 7, r: 4 })
    );

    const FileText = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('path', { d: "M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" }),
        h('polyline', { points: "14 2 14 8 20 8" }),
        h('line', { x1: 16, y1: 13, x2: 8, y2: 13 }),
        h('line', { x1: 16, y1: 17, x2: 8, y2: 17 }),
        h('line', { x1: 10, y1: 9, x2: 8, y2: 9 })
    );

    const Crown = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('path', { d: "m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7z" }),
        h('path', { d: "M3 20h18" })
    );

    const ChevronRight = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('polyline', { points: "9 18 15 12 9 6" })
    );

    const Upload = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('path', { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }),
        h('polyline', { points: "17 8 12 3 7 8" }),
        h('line', { x1: 12, y1: 3, x2: 12, y2: 15 })
    );

    const Mail = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('rect', { x: 2, y: 4, width: 20, height: 16, rx: 2 }),
        h('path', { d: "m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" })
    );

    const Calendar = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('rect', { x: 3, y: 4, width: 18, height: 18, rx: 2, ry: 2 }),
        h('line', { x1: 16, y1: 2, x2: 16, y2: 6 }),
        h('line', { x1: 8, y1: 2, x2: 8, y2: 6 }),
        h('line', { x1: 3, y1: 10, x2: 21, y2: 10 })
    );

    const AlertCircle = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('circle', { cx: 12, cy: 12, r: 10 }),
        h('line', { x1: 12, y1: 8, x2: 12, y2: 12 }),
        h('line', { x1: 12, y1: 16, x2: 12.01, y2: 16 })
    );

    const API_BASE_URL = 'https://mute-fae-macaroniu-ef8afb3f.koyeb.app';

    class ApiClient {
        constructor(baseUrl, initData) {
            this.baseUrl = baseUrl;
            this.initData = initData;
        }

        async request(endpoint, options = {}) {
            const url = `${this.baseUrl}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            // –î–æ–±–∞–≤–ª—è–µ–º Authorization —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å initData –∏–∑ TG
            if (this.initData) headers['Authorization'] = this.initData;

            try {
                const response = await fetch(url, {
                    ...options,
                    headers,
                    mode: 'cors'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        getUserProfile() {
            return this.request('/user/profile');
        }

        getUserResumes() {
            return this.request('/user/resumes');
        }

        getPlans() {
            return this.request('/plans');
        }

        updatePlan(planName) {
            return this.request('/user/update-plan', {
                method: 'POST',
                body: JSON.stringify({ plan_name: planName })
            });
        }
    }

    function JobSearchApp() {
        const [screen, setScreen] = useState('main');
        const [user, setUser] = useState(null);
        const [resumes, setResumes] = useState([]);
        const [plans, setPlans] = useState({});
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [apiClient, setApiClient] = useState(null);

        useEffect(() => {
            initializeApp();
        }, []);

        const initializeApp = async () => {
            try {
                // Telegram –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —ç—Ç–æ –±–æ–ª—å—à–µ –Ω–µ –æ—à–∏–±–∫–∞
                const tg = window.Telegram?.WebApp;
                const initData = tg?.initData || ''; // –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

                if (tg) {
                    tg.ready?.();
                    tg.expand?.();
                    tg.setHeaderColor?.('#1e293b');
                }

                const client = new ApiClient(API_BASE_URL, initData);
                setApiClient(client);

                await loadUserData(client);
            } catch (err) {
                console.error('Initialization error:', err);
                setError(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${err.message}`);
            } finally {
                setLoading(false);
            }
        };

        const loadUserData = async (client) => {
            try {
                const [userData, resumesData, plansData] = await Promise.all([
                    client.getUserProfile(),
                    client.getUserResumes(),
                    client.getPlans()
                ]);

                setUser(userData);
                setResumes(resumesData);
                setPlans(plansData);
            } catch (err) {
                console.error('Error loading user data:', err);
                // –ï—Å–ª–∏ –Ω–µ –∑–∞—à–ª–∏ —á–µ—Ä–µ–∑ TG ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –±–∞–∑–æ–≤—ã–π —ç–∫—Ä–∞–Ω –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
                setUser(null);
                setPlans({});
                setError(null);
            }
        };

        if (loading) {
            return h('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center' },
                h('div', { className: 'text-center' },
                    h('div', { className: 'w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-4' }),
                    h('p', { className: 'text-slate-600' }, '–ó–∞–≥—Ä—É–∑–∫–∞...')
                )
            );
        }

        return h('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100' },
            h('div', { className: 'max-w-2xl mx-auto p-4 pb-8' },
                h('div', { className: 'bg-white rounded-2xl p-6 shadow-lg' },
                    h('h2', { className: 'text-2xl font-bold mb-4' }, `–ü—Ä–∏–≤–µ—Ç${user?.name ? `, ${user.name}!` : ''} üëã`),
                    user?.plan ? h('p', { className: 'text-slate-600' }, `–ü–ª–∞–Ω: ${user.plan}`) :
                        h('p', { className: 'text-slate-600' }, '–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏ —Ä–µ–∑—é–º–µ'),
                    user?.resumeCount != null ? h('p', { className: 'text-slate-600' }, `–†–µ–∑—é–º–µ: ${user.resumeCount}`) : null
                )
            )
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(h(JobSearchApp));
</script>
</body>
</html>
