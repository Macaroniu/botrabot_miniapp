<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BotRabot Job Search</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        #root {
            min-height: 100vh;
        }
    </style>
</head>
<body>
<div id="root"></div>

<script type="module">
    import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

    const { createElement: h } = React;

    // Icons as functions returning React elements
    const Search = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('circle', { cx: 11, cy: 11, r: 8 }),
        h('path', { d: "m21 21-4.35-4.35" })
    );

    const User = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('path', { d: "M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" }),
        h('circle', { cx: 12, cy: 7, r: 4 })
    );

    const FileText = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('path', { d: "M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" }),
        h('polyline', { points: "14 2 14 8 20 8" }),
        h('line', { x1: 16, y1: 13, x2: 8, y2: 13 }),
        h('line', { x1: 16, y1: 17, x2: 8, y2: 17 }),
        h('line', { x1: 10, y1: 9, x2: 8, y2: 9 })
    );

    const Crown = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('path', { d: "m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7z" }),
        h('path', { d: "M3 20h18" })
    );

    const ChevronRight = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('polyline', { points: "9 18 15 12 9 6" })
    );

    const Upload = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('path', { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }),
        h('polyline', { points: "17 8 12 3 7 8" }),
        h('line', { x1: 12, y1: 3, x2: 12, y2: 15 })
    );

    const Mail = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('rect', { x: 2, y: 4, width: 20, height: 16, rx: 2 }),
        h('path', { d: "m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" })
    );

    const Calendar = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('rect', { x: 3, y: 4, width: 18, height: 18, rx: 2, ry: 2 }),
        h('line', { x1: 16, y1: 2, x2: 16, y2: 6 }),
        h('line', { x1: 8, y1: 2, x2: 8, y2: 6 }),
        h('line', { x1: 3, y1: 10, x2: 21, y2: 10 })
    );

    const AlertCircle = () => h('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" },
        h('circle', { cx: 12, cy: 12, r: 10 }),
        h('line', { x1: 12, y1: 8, x2: 12, y2: 12 }),
        h('line', { x1: 12, y1: 16, x2: 12.01, y2: 16 })
    );

    const API_BASE_URL = 'https://mute-fae-macaroniu-ef8afb3f.koyeb.app';

    class ApiClient {
        constructor(baseUrl, initData) {
            this.baseUrl = baseUrl;
            this.initData = initData;
        }

        async request(endpoint, options = {}) {
            const url = `${this.baseUrl}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': this.initData,
                ...options.headers
            };

            try {
                console.log('API Request:', url);

                const response = await fetch(url, {
                    ...options,
                    headers,
                    mode: 'cors'
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        getUserProfile() {
            return this.request('/user/profile');
        }

        getUserResumes() {
            return this.request('/user/resumes');
        }

        getPlans() {
            return this.request('/plans');
        }

        updatePlan(planName) {
            return this.request('/user/update-plan', {
                method: 'POST',
                body: JSON.stringify({ plan_name: planName })
            });
        }
    }

    function JobSearchApp() {
        const [screen, setScreen] = useState('main');
        const [user, setUser] = useState(null);
        const [resumes, setResumes] = useState([]);
        const [plans, setPlans] = useState({});
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [apiClient, setApiClient] = useState(null);

        useEffect(() => {
            initializeApp();
        }, []);

        const initializeApp = async () => {
            try {
                console.log('Initializing app...');

                if (!window.Telegram?.WebApp) {
                    throw new Error('Telegram WebApp not available');
                }

                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                tg.setHeaderColor('#1e293b');

                const initData = tg.initData;

                if (!initData) {
                    setError('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ Telegram');
                    setLoading(false);
                    return;
                }

                const client = new ApiClient(API_BASE_URL, initData);
                setApiClient(client);

                await loadUserData(client);

            } catch (err) {
                console.error('Initialization error:', err);
                setError(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${err.message}`);
            } finally {
                setLoading(false);
            }
        };

        const loadUserData = async (client) => {
            try {
                const [userData, resumesData, plansData] = await Promise.all([
                    client.getUserProfile(),
                    client.getUserResumes(),
                    client.getPlans()
                ]);

                setUser(userData);
                setResumes(resumesData);
                setPlans(plansData);

            } catch (err) {
                console.error('Error loading user data:', err);
                setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ù–∞–ø–∏—à–∏—Ç–µ /start –±–æ—Ç—É.');
            }
        };

        if (loading) {
            return h('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center' },
                h('div', { className: 'text-center' },
                    h('div', { className: 'w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-4' }),
                    h('p', { className: 'text-slate-600' }, '–ó–∞–≥—Ä—É–∑–∫–∞...')
                )
            );
        }

        if (error) {
            return h('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-4' },
                h('div', { className: 'bg-white rounded-2xl p-8 max-w-md text-center shadow-lg' },
                    h('div', { className: 'w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4' },
                        h(AlertCircle)
                    ),
                    h('h3', { className: 'text-xl font-bold text-slate-800 mb-2' }, '–û—à–∏–±–∫–∞'),
                    h('p', { className: 'text-slate-600 mb-4' }, error),
                    h('button', {
                        onClick: () => window.location.reload(),
                        className: 'bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium'
                    }, '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞')
                )
            );
        }

        if (!user) {
            return h('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-4' },
                h('div', { className: 'bg-white rounded-2xl p-8 max-w-md text-center shadow-lg' },
                    h('p', { className: 'text-slate-600' }, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω')
                )
            );
        }

        return h('div', { className: 'min-h-screen bg-gradient-to-br from-slate-50 to-slate-100' },
            h('div', { className: 'max-w-2xl mx-auto p-4 pb-8' },
                h('div', { className: 'bg-white rounded-2xl p-6 shadow-lg' },
                    h('h2', { className: 'text-2xl font-bold mb-4' }, `–ü—Ä–∏–≤–µ—Ç, ${user.name}! üëã`),
                    h('p', { className: 'text-slate-600' }, `–ü–ª–∞–Ω: ${user.plan}`),
                    h('p', { className: 'text-slate-600' }, `–†–µ–∑—é–º–µ: ${user.resumeCount}`)
                )
            )
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(h(JobSearchApp));
</script>
</body>
</html>